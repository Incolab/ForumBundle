<?php

namespace Incolab\ForumBundle\Repository;

use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * CategoryRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CategoryRepository extends \Doctrine\ORM\EntityRepository {

    public static $strIndexQuery = "SELECT c, ch, crr, "
            . "partial t.{id, author, subject, slug, createdAt}, "
            . "partial p.{id, topic, author, createdAt}, "
            . "a, pa, "
            . "partial pt.{id, subject, slug} "
            . "FROM IncolabForumBundle:Category c LEFT JOIN c.readRoles crr "
            . "LEFT JOIN c.childs ch LEFT JOIN ch.readRoles chrr "
            . "LEFT JOIN ch.lastTopic t LEFT JOIN t.author a "
            . "LEFT JOIN ch.lastPost p LEFT JOIN p.topic pt LEFT JOIN p.author pa "
            . "WHERE c.parent IS NULL AND crr IN (:readRole) OR chrr IN (:chreadRole) "
            . "ORDER BY c.position ASC, ch.position ASC";
    public static $strParentCatQuery = "SELECT c, ch, "
            . "partial t.{id, author, subject, category, slug, createdAt}, "
            . "partial p.{id, topic, author, createdAt}, "
            . "ta, pa, "
            . "partial pt.{id, subject, slug} "
            . "FROM IncolabForumBundle:Category c LEFT JOIN c.readRoles crr "
            . "LEFT JOIN c.childs ch LEFT JOIN ch.readRoles chrr "
            . "LEFT JOIN ch.lastTopic t LEFT JOIN t.author ta "
            . "LEFT JOIN ch.lastPost p LEFT JOIN p.topic pt LEFT JOIN p.author pa "
            . "WHERE c.slug = :slug AND c.parent IS NULL ";
    public static $strParentsWithChilds = "SELECT c, ch "
            . "FROM IncolabForumBundle:Category c "
            . "LEFT JOIN c.childs ch "
            . "WHERE c.parent IS NULL "
            . "ORDER BY c.position ASC, ch.position ASC";
    public static $strGetCategoryBySlugAndParentSlug = "SELECT c, p, t, lp, lpa, crr "
            . "FROM IncolabForumBundle:Category c LEFT JOIN c.parent p "
            . "LEFT JOIN c.topics t LEFT JOIN t.lastPost lp LEFT JOIN lp.author lpa "
            . "INNER JOIN c.readRoles crr "
            . "WHERE c.slug = :cslug AND p.slug = :pslug";
    public static $strGetCategoryForInsertTopic = "SELECT p, ch "
            . "FROM IncolabForumBundle:Category p LEFT JOIN p.childs ch "
            . "WHERE p.slug = :parentSlug AND p.parent IS NULL AND ch.slug = :childSlug";
    
    public function getIndex($roles = array()) {
        $query = $this->_em->createQuery(self::$strIndexQuery)->setParameters([":readRole" => $roles, ":chreadRole" => $roles]);
        return $query->getResult();
    }

    public function getParents() {
        $categories = $this->createQueryBuilder('p')
                        ->where('p.parent IS NULL')
                        ->orderBy('p.position', 'ASC')
                        ->getQuery()->getResult();

        return $categories;
    }

    public function getParentsWithChilds() {
        $query = $this->_em->createQuery(self::$strParentsWithChilds);
        return $query->getResult();
    }

    public function getParentBySlug($slug) {
        $parentCat = $this->createQueryBuilder('c')
                        ->where('c.slug = :slug AND c.parent IS NULL')
                        ->setParameter(':slug', $slug)
                        ->getQuery()->setMaxResults(1)->getOneOrNullResult();
        return $parentCat;
    }

    // A changer pour le paginator
    public function getParentCategoryPageBySlug($slug, $page = 1, $maxperpage = 10) {
        $parentCategory = $this->createQueryBuilder('p')
                ->leftJoin('p.childs', 'c')
                ->leftJoin('c.lastTopic', 'l')
                ->leftJoin('c.lastPost', 'm')
                ->leftJoin('l.author', 'a')
                ->leftJoin('m.author', 'b')
                ->addSelect('c')
                ->addSelect('partial l.{id, author, subject, category, slug, createdAt}')
                ->addSelect('partial m.{id, topic, author, createdAt}')
                ->addSelect('partial a.{id, username}')
                ->addSelect('partial b.{id, username}')
                ->where('p.slug = :slug AND p.parent IS NULL')
                ->setParameter(':slug', $slug)
                //->getQuery()->getOneOrNullResult()
                ->setFirstResult(($page - 1) * $maxperpage)
                ->setMaxResults($maxperpage)
        ;

        return new Paginator($parentCategory);
    }

    public function getParentCategoryBySlug($readRoles, $slug) {
        $strQuery = self::$strParentCatQuery . "AND (crr IN (:readRole) OR chrr IN (:chreadRole))";

        $parameters = [
                    ":slug" => $slug,
                    ":readRole" => $readRoles,
                    ":chreadRole" => $readRoles
        ];

        $strQuery = $strQuery . "ORDER BY c.position ASC, ch.position ASC";
        $query = $this->_em->createQuery($strQuery)->setParameters($parameters);

        return $query->getOneOrNullResult();
    }

    public function getCategoryBySlugAndParentSlug($slug, $parentSlug) {
        $params = [
            'cslug' => $slug,
            'pslug' => $parentSlug
        ];
        
        $query = $this->_em->createQuery(self::$strGetCategoryBySlugAndParentSlug)
                ->setParameters($params);
        
        return $query->getOneOrNullResult();
    }

    // A changer pour le paginator
    public function getCategoryPageBySlugAndParentSlug($slug, $parentSlug) {
        $category = $this->createQueryBuilder('c')
                        ->leftJoin('c.parent', 'p')
                        ->leftJoin('c.topics', 't')
                        ->leftJoin('t.author', 'ta')
                        ->leftJoin('t.lastPost', 'l')
                        ->leftJoin('l.author', 'la')
                        ->addSelect('p')
                        ->addSelect('distinct t')
                        ->addSelect('partial ta.{id, username}')
                        ->addSelect('l')
                        ->addSelect('partial la.{id, username}')
                        ->where('c.slug = :slugCat AND p.slug = :slugParent')
                        ->setParameters(array(':slugCat' => $slug, ':slugParent' => $parentSlug))
                        ->getQuery()->getOneOrNullResult();
        return $category;
    }

    public function getCategoryForInsertTopic($slug, $parentSlug) {
        $query = $this->_em->createQuery(static::$strGetCategoryForInsertTopic)
                ->setParameters([':parentSlug' => $parentSlug, ':childSlug' => $slug]);
        return $query->getOneOrNullResult();
    }

}
